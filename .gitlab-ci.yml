# SPDX-License-Identifier: CC0-1.0
# SPDX-FileCopyrightText: 2023 Collabora, Ltd.

# ccache?

variables:
  GIT_SUBMODULE_STRATEGY: recursive

stages:
  - build
  - analyze
  - release

cache:
  paths:
    - ccache

.ccache:
  before_script:
    - export CCACHE_BASEDIR="$PWD"
    - export CCACHE_DIR="$PWD/ccache"
    - export CCACHE_COMPILERCHECK=content
    - ccache --zero-stats || true
    - ccache --show-stats || true
  after_script:
    - export CCACHE_DIR="$PWD/ccache"
    - ccache --show-stats -v

gcc-ubuntu-2204:
  extends: .ccache
  image: registry.freedesktop.org/mateosss/basalt:ubuntu2204
  stage: build
  when: manual
  script:
    - echo BUILD_UBUNTU_2204_JOB_ID=$CI_JOB_ID >> release.env
    - cmake --preset=ci
    - time cmake --build build
    - cd build && cpack
    - mv *.deb ../basalt-monado-ubuntu-22.04-haswell-amd64.deb
  artifacts:
    name: basalt-monado-ubuntu-22.04-haswell-amd64
    expose_as: "basalt-monado-ubuntu-2204-haswell-amd64-deb"
    paths:
      - "basalt-monado-ubuntu-22.04-haswell-amd64.deb"
    reports:
      dotenv: release.env

gcc-ubuntu-2404:
  extends: .ccache
  image: registry.freedesktop.org/mateosss/basalt:ubuntu2404
  stage: build
  when: manual
  script:
    - echo BUILD_UBUNTU_2404_JOB_ID=$CI_JOB_ID >> release.env
    - cmake --preset=ci
    - time cmake --build build
    - cd build && cpack
    - mv *.deb ../basalt-monado-ubuntu-24.04-haswell-amd64.deb
  artifacts:
    name: basalt-monado-ubuntu-24.04-haswell-amd64
    expose_as: "basalt-monado-ubuntu-2404-haswell-amd64-deb"
    paths:
      - "basalt-monado-ubuntu-24.04-haswell-amd64.deb"
    reports:
      dotenv: release.env

clang19-ubuntu-2404:
  extends: .ccache
  image: registry.freedesktop.org/mateosss/basalt:ubuntu2404
  stage: build
  when: manual
  script:
    - apt-get update && apt-get install -y clang-19
    - export CC=clang-19 CXX=clang++-19
    - cmake --preset=ci
    - time cmake --build build

clangd-tidy-delta:
  stage: analyze
  image: registry.freedesktop.org/mateosss/basalt:ubuntu2404
  when: manual
  script:
    - git fetch origin $CI_DEFAULT_BRANCH
    - cmake -B build
    - git diff origin/$CI_DEFAULT_BRANCH --exit-code || IN_MR=$?
    - (( $IN_MR )) && COMPARISON_BRANCH=origin/$CI_DEFAULT_BRANCH || COMPARISON_BRANCH=HEAD~1
    - echo $COMPARISON_BRANCH
    - source /venv/bin/activate
    - git diff $COMPARISON_BRANCH --name-only | xargs clangd-tidy --clangd-executable=/clangd/bin/clangd -p build -j $(nproc) --github --color always

format:
  stage: analyze
  image: registry.freedesktop.org/mateosss/basalt:ubuntu2404
  when: manual
  script:
    - ./scripts/format.sh
    - git diff --exit-code

release:
  stage: release
  image: registry.freedesktop.org/mateosss/basalt:ubuntu2204
  when: manual
  script:
    - echo "Releasing artifacts of previous jobs"
    - curl --location --output /usr/local/bin/release-cli "https://gitlab.com/api/v4/projects/gitlab-org%2Frelease-cli/packages/generic/release-cli/latest/release-cli-linux-amd64"
    - chmod +x /usr/local/bin/release-cli
  needs: ["gcc-ubuntu-2204", "gcc-ubuntu-2404"]
  release:
    name: "Release of $CI_COMMIT_SHORT_SHA"
    tag_name: "release-$CI_COMMIT_SHORT_SHA"
    description: "Release of Monado's Basalt for $CI_COMMIT_SHORT_SHA"
    assets:
      links:
        - name: "Ubuntu 22.04 .deb (amd64, -march=haswell)"
          url: "https://gitlab.freedesktop.org/mateosss/basalt/-/jobs/${BUILD_UBUNTU_2204_JOB_ID}/artifacts/raw/basalt-monado-ubuntu-22.04-haswell-amd64.deb"
          link_type: package
        - name: "Ubuntu 24.04 .deb (amd64, -march=haswell)"
          url: "https://gitlab.freedesktop.org/mateosss/basalt/-/jobs/${BUILD_UBUNTU_2404_JOB_ID}/artifacts/raw/basalt-monado-ubuntu-24.04-haswell-amd64.deb"
          link_type: package
